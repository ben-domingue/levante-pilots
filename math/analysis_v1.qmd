---
format: html
---

```{r}
library(ltm)
library(tidyverse)
library(glue)
library(ggforce)
library(ggthemes)
library(GGally)

.font <- "Source Sans Pro"
theme_set(theme_bw(base_size = 14, base_family = .font))
theme_update(panel.grid = element_blank(),
             strip.background = element_blank(),
             legend.key = element_blank(),
             panel.border = element_blank(),
             axis.line = element_line(),
             strip.text = element_text(face = "bold"))
```

```{r}
# raw data imported in mental-rotation/analysis_v1.qmd
load(file="data_processed/2024-03-11-pilot.Rdata")
item_bank <- read_csv("data_processed/math-item-bank.csv") 
#  filter(notes!="practice")

math <- trials |> filter(task_id == "egma-math")

complete_math_subs <- math |> group_by(user_id) |> 
  summarise(n = n()) |> filter(n > 180) |> pull(user_id) 
# should be 188

math_g <- math |> filter(is.element(user_id, complete_math_subs))
```

```{r}
sort(table(math_g$trial_index))
mp <- math_g |> filter(trial_index != 5) |>
  mutate(task = case_when(str_detect(item, "-") ~ "subtraction",
                          str_detect(item, "_") ~ "sequence",
                          str_detect(item, "x") ~ "multiplication",
                          str_detect(item, "\\+") ~ "addition",
                          str_detect(item, "\\{") ~ "line-to-number", # but 4afc or slider response?
                          str_count(item, ",")==1 ~ "number comparison",
                          trial_index<=65 ~ "number identification",
                          TRUE ~ NA)) |>
  mutate(task = ifelse(trial_index>=461, "number-to-line", task))

table(mp$task)

mp |> group_by(trial_index, expected_answer, item) |> summarise(acc = mean(is_correct))
# last number identification trial: trial_index=65

m_acc <- mp |> filter(task!="number-to-line") |>
  group_by(user_id, task) |>
  summarise(subj_acc = mean(is_correct))

m_rt <- mp |> filter(task!="number-to-line") |>
  group_by(user_id, task, is_correct) |>
  summarise(RT = median(rt, na.rm=T))
```



```{r}
ms <- m_acc |> group_by(task) |>
  summarise(accuracy = mean(subj_acc),
            sd = sd(subj_acc),
            n = n(),
            se = sd / sqrt(n))

ms |> ggplot(aes(x=reorder(task, -accuracy), y=accuracy)) +
  geom_pointrange(aes(ymin = accuracy-se, ymax = accuracy+se)) +
  ylab("mean accuracy") + xlab("task") +
  coord_flip()
```



```{r}
ms_rt <- m_rt |> group_by(task, is_correct) |>
  summarise(RT = mean(RT, na.rm=T),
            sd = sd(RT, na.rm=T),
            n = n(),
            se = sd / sqrt(n))

ms_rt |> filter(is_correct) |>
  ggplot(aes(x = reorder(task, -RT), y = RT)) +
  geom_pointrange(aes(ymin = RT-se, ymax = RT+se)) +
  ylab("Mean of subjects' median correct RT") + xlab("task") +
  coord_flip()
```

